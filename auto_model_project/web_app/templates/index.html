<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>10-K AutoModel | Generate Excel</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --accent: #1b6ef3;
      --text: #1f2a3d;
      --muted: #5f6b7a;
      --border: #e4e8f0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 22px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .brand a {
      color: var(--text);
      text-decoration: none;
      font-weight: 700;
      font-size: 18px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .nav-links a {
      margin-left: 14px;
      text-decoration: none;
      color: var(--muted);
      font-weight: 600;
    }
    .nav-links a:hover { color: var(--text); }
    .container {
      max-width: 1080px;
      margin: 40px auto 80px;
      padding: 0 16px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(18, 38, 63, 0.08);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 28px;
    }
    p.lead {
      margin: 0 0 20px;
      color: var(--muted);
    }
    label {
      display: block;
      font-weight: 600;
      margin: 14px 0 6px;
    }
    input[type="text"], input[type="file"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fbff;
      font-size: 14px;
    }
    .button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.1s ease;
    }
    .button:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(27,110,243,0.2); }
    .muted { color: var(--muted); font-size: 13px; }
    .flex { display: flex; gap: 18px; flex-wrap: wrap; }
    .half { flex: 1 1 320px; }
    .drop-zone {
      border: 1.5px dashed var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .drop-zone.dragover {
      border-color: var(--accent);
      background: #eef3ff;
    }
    .messages { margin-bottom: 16px; }
    .msg {
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
    }
    .msg.error { background: #ffe8e6; color: #a12a2a; border: 1px solid #f5c2c0; }
    .msg.success { background: #e8f7ef; color: #1f7a47; border: 1px solid #c3ead1; }
  </style>
</head>
<body>
  <header>
    <div class="brand"><a href="{{ url_for('index') }}">ðŸ“Š 10-K AutoModel</a></div>
    <div class="nav-links">
      <a href="{{ url_for('index') }}">App</a>
      <a href="{{ url_for('dashboard') }}">Dashboard</a>
      <a href="{{ url_for('help_page') }}">Help</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <h1>Generate Final Excel from URL or HTML</h1>
      <p class="lead">Paste a 10-K URL or upload HTML and get a clean Excel model in one click.</p>

      <div class="messages">
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            {% for message in messages %}
              <div class="msg success">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>

      <form method="post" enctype="multipart/form-data" id="mainForm" action="{{ url_for('index') }}">
        <div class="flex">
          <div class="half">
            <h3>Step 1 â€” Provide URL or upload HTML</h3>
            <label for="urlInput">Enter or drop a URL</label>
            <div id="dropZone" class="drop-zone">
              <input type="text" name="url" id="urlInput" placeholder="https://example.com/somepage" autocomplete="url" />
              <div class="muted">Drag & drop a link here, or paste a URL. If both URL and file are provided, the URL will be used.</div>
            </div>

            <label>Or upload HTML File (.html / .htm)</label>
            <input type="file" name="file" accept=".html,.htm" />
          </div>

          <div class="half">
            <h3>Step 2 â€” Company name</h3>
            <label for="company">Company</label>
            <input type="text" name="company" id="company" placeholder="e.g. Apple Inc." required autocomplete="organization" />

            <h3 style="margin-top:18px;">Step 3 â€” Options</h3>
            <p class="muted">OpenAI label mapping is always enabled for this model.</p>
            <input type="hidden" name="use_llm_flag" value="1" />
          </div>
        </div>

        <div style="margin-top:24px;">
          <input type="hidden" name="ajax" value="1" />
          <button class="button" type="submit">Generate</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      const drop = document.getElementById('dropZone');
      const urlInput = document.getElementById('urlInput');
      const form = document.getElementById('mainForm');
      const submitBtn = form.querySelector('button[type=\"submit\"]');

      drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.classList.add('dragover'); });
      drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
      drop.addEventListener('drop', (e) => {
        e.preventDefault();
        drop.classList.remove('dragover');
        const items = e.dataTransfer.items;
        if (items) {
          for (let i=0; i<items.length; i++) {
            const it = items[i];
            if (it.kind === 'string') {
              it.getAsString((s) => {
                const m = s.match(/https?:\/\/[\\S]+/);
                if (m) urlInput.value = m[0];
              });
            }
          }
        }
      });

      urlInput.addEventListener('paste', () => {
        setTimeout(() => { urlInput.value = urlInput.value.trim(); }, 10);
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        const original = submitBtn.textContent;
        submitBtn.textContent = 'Generating...';

        const fd = new FormData(form);
        try {
          const resp = await fetch(form.action, { method: 'POST', body: fd, credentials: 'same-origin' });
          if (!resp.ok) {
            const text = await resp.text();
            console.error('Server error:', text);
            alert('Server error during generation. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = original;
            return;
          }
          const disposition = resp.headers.get('Content-Disposition') || '';
          let filename = 'final.xlsx';
          const m = disposition.match(/filename=\"?([^\";]+)\"?/);
          if (m) filename = m[1];
          const blob = await resp.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename;
          document.body.appendChild(a); a.click(); a.remove();
          window.URL.revokeObjectURL(url);
        } catch (err) {
          console.error(err);
          alert('Error generating file. See console for details.');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = original;
        }
      });
    })();
  </script>
</body>
</html>
